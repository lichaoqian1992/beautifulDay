package com.manji.sheet.service;

import com.jfinal.plugin.activerecord.Db;
import com.jfinal.plugin.activerecord.Record;

import java.util.List;

/**
 * Created by lcq on 2017/6/15.
 */
public class PCService {


    /**
     * 根据对应类型获取页面信息
     * @param sponsor_id
     * @param short_title
     * @param shop_user_id
     * @param start_time
     * @param end_time
     * @param status
     * @param sheet_no
     * @return
     */
    public List<Record> getInformation(int sponsor_id,String short_title,Integer shop_user_id,String start_time,String end_time,Integer status,String sheet_no) {

        StringBuffer sb = new StringBuffer();

        //根据传入类型显示数据
        if (short_title == "FEB") {
            sb.append("select  t.title,t.status,s.sheet_no,s.start_time from dt_sheets s left join dt_sheet_type t  on  s.type_code = t.code " +
                    " where t.short_title='FEB' and t.layer=2 and s.sponsor_id="+sponsor_id);
        } else if (short_title == "RMJ") {
            sb.append("select  t.title,t.status,s.sheet_no,s.start_time from dt_sheets s left join dt_sheet_type t  on  s.type_code = t.code " +
                    " where t.short_title='RMJ' and t.layer=2 and s.sponsor_id="+sponsor_id);
        } else if (short_title == "RGD" || short_title == "RSH") {
            sb.append("select b.shop_user_id,s.sheet_no,s.start_time,s.sponsor,s.status,t.title,t.merge_title from dt_sheets s " +
                    "left join dt_sheet_business b on s.id = b.sheet_id " +
                    "left join dt_sheet_type t on s.type_code=t.code " +
                    "where t.short_title in ('RSD','RSH') and t.layer=2 and b.shop_user_id= "+shop_user_id);
        } else if (short_title == "EVD") {
            sb.append("select b.shop_user_id,s.sheet_no,s.start_time,s.sponsor,s.status,t.title,t.merge_title from dt_sheets s " +
                    "left join dt_sheet_business b on s.id = b.sheet_id " +
                    "left join dt_sheet_type t on s.type_code=t.code " +
                    "where t.short_title = 'EVD' and t.layer=2 and b.shop_user_id= "+shop_user_id);
        } else if (short_title == "TRD") {
            sb.append("select b.shop_user_id,s.sheet_no,s.start_time,s.sponsor,s.status,t.title,t.merge_title from dt_sheets s " +
                    "left join dt_sheet_business b on s.id = b.sheet_id " +
                    "left join dt_sheet_type t on s.type_code=t.code " +
                    "where t.short_title = 'TRD' and t.layer=2 and b.shop_user_id= "+shop_user_id);
        }

        //根据条件搜索
        if (start_time != null && !"".equals(start_time)) {
            sb.append(" and s.start_time>"+start_time);
        }
        if (end_time != null && !"".equals(end_time)) {
            sb.append(" and s.start_time<"+end_time);
        }
        if (status != null && !"".equals(status)) {
            sb.append("s.status="+status);
        }
        if (sheet_no != null && !"".equals(sheet_no)) {
            sb.append("s.sheet_no="+sheet_no);
        }
        List<Record> records = Db.find(sb.toString());

        return records;
    }


    /**
     * 我要建议详情信息
     * @param sheet_no
     * @param status
     * @return
     */
    public Record getAccept(String sheet_no,int status){

        StringBuffer sb = new StringBuffer();

        if (status == 1) {
            sb.append("select s.sheet_no,s.start_time,t.title,t.status,i.descr,i.pics from dt_sheets s " +
                    "left join dt_sheet_type t on s.type_code=t.code " +
                    "left join dt_sheet_info i on s.id=i.sheet_id " +
                    "where s.sheet_no = "+sheet_no+" and status ="+status);
        } else {
            sb.append("select s.sheet_no,s.start_time,t.title,t.status,i.descr,i.pics,d.content,d.pics as d_pics from dt_sheets s " +
                    "left join dt_sheet_type t on s.type_code=t.code " +
                    "left join dt_sheet_info i on s.id=i.sheet_id " +
                    "left join dt_sheet_detail d on s.id=d.sheet_id " +
                    "where s.sheet_no ="+sheet_no+" and status ="+status);
        }

        Record record = Db.findFirst(sb.toString());

        return record;
    }

    /**
     * 发起建议
     */

    public  void addSuggestion(){


    }

    /**
     * 详情中通用的工单信息
     * @param sheet_no
     * @return
     */
    public Record commonSheet(String sheet_no) {

        String sql = "select s.sheet_no,s.start_time,t.title from  dt_sheets s,dt_sheet_type t where s.type_code=t.code and sheet_no="+sheet_no;
        Record record = Db.findFirst(sql);

        return record;
    }


    /**
     * 产生纠纷的资料信息
     * @param sheet_no
     * @return
     */
    public List<Record> disputeInfo(String sheet_no){

        String sql = "select s.id,s.sheet_no,i.descr,i.pics,i.add_time,i.submitter   from dt_sheets s,dt_sheet_info  i " +
                "where s.id=i.sheet_id and s.sheet_no=?";

        List<Record> records = Db.find(sql,sheet_no);

        return records;
    }

    /**
     * 添加补充资料
     * @param record
     */
    public boolean addInformation(Record record){

        Record r = new Record();

        return Db.save("dt_sheet_info",record);
    }

    /**
     * 仲裁结果
     * @param sheet_no
     * @return
     */
    public Record arbResult(String sheet_no){

        String sql = "select s.id,s.sheet_no,d.content,d.pics from dt_sheets s,dt_sheet_detail d " +
                "where s.id=d.sheet_id and s.sheet_no=? ";

        Record record = Db.findFirst(sql,sheet_no);

        return record;
    }

    /**
     * 处罚结果
     * @param sheet_no
     * @return
     */
    public Record pulish(String sheet_no) {

        String sql = "select p.* from dt_sheet s,dt_sheet_pulish p where s.id=p.sheet_id where s.sheet_no="+sheet_no;

        Record record = Db.findFirst(sql);

        return record;
    }

    /**
     * 根据单号查询商品名
     * @param sheet_no
     * @return
     */
    public Record aritcle(String sheet_no){

        String sql = "select title from dt_article where id=(select article_id from dt_sheet_business where sheet_id=(select id from dt_sheets where sheet_no="+sheet_no+"))";

        Record record = Db.findFirst(sql);

        return record;
    }
    /**
     * 我被举报列表
     * @param shop_user_id
     * @return
     */
    public List<Record> reported(long shop_user_id,String start_time,String end_time,Integer status,String sheet_no){

        StringBuffer sb = new StringBuffer("select b.shop_user_id,s.sheet_no,s.start_time,s.sponsor,s.status,t.title,t.merge_title from dt_sheet_business b " +
                "left join dt_sheets s on b.sheet_id=s.id " +
                "left join dt_sheet_type t on s.type_code=t.code " +
                "where t.layer=2 and b.shop_user_id= "+shop_user_id);
        if (start_time != null && !"".equals(start_time)) {
            sb.append(" and s.start_time>"+start_time);
        }
        if (end_time != null && !"".equals(end_time)) {
            sb.append(" and s.start_time<"+end_time);
        }
        if (status != null && !"".equals(status)) {
            sb.append(" and s.status="+status);
        }
        if (sheet_no != null && !"".equals(sheet_no)) {
            sb.append(" and s.sheet_no like '%"+sheet_no+"%'");
        }
        List<Record> records = Db.find(sb.toString());

        return records;
    }

    //根据sheet_no查询出用户id和商家id
    public Record userShopInfo(String sheet_no) {

        String sql = "select user_id,shop_user_id from dt_orders where order_no= " +
                "(select order_id from dt_sheet_business where sheet_id = " +
                "(select sheet_id from dt_sheets where sheet_no = "+sheet_no+"))";
        Record record = Db.findFirst(sql);

        return record;
    }

    /**
     * 根据传入的sheet_no查出用户的昵称和电话
     * @param sheet_no
     * @return
     */
    public Record userInfo(String sheet_no){

        Record rec = userShopInfo(sheet_no);
        String sql = "select user_name,mobile from dt_user where id="+rec.get("user_id");
        Record record = Db.findFirst(sql);

        return record;
    }

    /**
     * 根据传入的sheet_no查出商家的名称和电话
     * @param sheet_no
     * @return
     */
    public Record shopInfo(String sheet_no) {

        Record rec = userShopInfo(sheet_no);
        String sql = "select name,mobile from dt_user_role_shopinfo where user_id="+rec.get("shop_user_id");
        Record record = Db.findFirst(sql);

        return record;
    }


}
