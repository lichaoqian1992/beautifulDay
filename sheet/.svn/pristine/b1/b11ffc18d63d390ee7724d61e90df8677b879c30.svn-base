package com.manji.sheet.controller;

import com.jfinal.aop.Before;
import com.jfinal.core.Controller;
import com.jfinal.plugin.activerecord.Record;
import com.manji.sheet.intercepter.AppIntercepter;
import com.manji.sheet.model.bean.Account;
import com.manji.sheet.service.ShopAppService;
import com.manji.sheet.utils.GetAccountUtils;
import com.manji.sheet.utils.WorkerNumberUtil;
import net.sf.json.JSONObject;

import java.util.List;

/**
 * Created by pudding on 2017-6-19.(YYR 商家APP控制器)
 */
@Before(AppIntercepter.class)
public class ShopController extends Controller {

    ShopAppService shopAppService=new ShopAppService();

    //进入举报管理页面
    public void ReportManagement(){
        Account account=getSessionAttr("Account");
        render("report/report_manage.html");
    }

    //进入交易纠纷页面
    public void TransactionDisputes(){

        render("dispute/dispute_manage.html");
    }

    //进入我要建议页面
    public void Proposal(){

        render("opinion/my_suggest.html");
    }

    public void LaunchAreport(){

    }


    //发起工单
    public void saveSheet(){
        String short_title=getPara("short_title");
        String code_type=getPara("code_type");
        String descr=getPara("descr");
        String status="1";//默认状态为待处理
        String sheet_no=WorkerNumberUtil.GeneratWorkerNumber(short_title); //生成工单号
        shopAppService.saveSheets(sheet_no,status,code_type,"","","","","Shop","加急","0");//生成工单
        Record record=shopAppService.findSheetBySheetNo(sheet_no);//获取工单
        shopAppService.saveSheetInfo(record.get("id").toString(),descr,null,null);
    }


    /**
     * 我被举报
     */
    public void IwasReported(){

        Account account=getSessionAttr("Account");//获取session里存入的用户

        if (account!=null){
            List<Record> recordList=shopAppService.IwasReported(account.getUser_id());
            setAttr("recordList",recordList);
        }

        render("");
    }


    /**
     * 我的举报
     */
    public void Myreport(){
        Account account=getSessionAttr("Account");//获取session里存入的用户

        if (account!=null){
            List<Record> recordList=shopAppService.MyReported(account.getUser_id());
            setAttr("recordList",recordList);
        }
        render("");
    }

    /**
     * 点击单个工单时(查询对应工单详细信息)
     */
    public void findSheetInfo(){
        String id=getPara("id");
        //查询出工单写详细信息
        Record sheet=shopAppService.findSheetById(id);
        //查询有无补充质料
        List<Record> sheetInfo=shopAppService.findSheetInfo(id);
        if (sheet.getInt("status")==4){//如果此订单已完成查询出处理说明
            Record sheetDetail=shopAppService.findSheetDetail(id);//查询工单详细信息
            setAttr("sheetDetail",sheetDetail);
        }
        setAttr("sheetInfo",sheetInfo);
        setAttr("sheet",sheet);

        render("");
    }

    /**
     * 点击已解决
     */
    public void updateStatus(){
        String result=getPara("result");

        //shopAppService.saveSheetflowlog();//修改状态为已解决
    }



}
