package com.manji.sheet.controller;

import java.io.IOException;

import javax.servlet.http.HttpSession;

import com.jfinal.aop.Before;
import com.jfinal.aop.Clear;
import com.jfinal.core.Controller;
import com.jfinal.plugin.activerecord.Record;
import com.manji.sheet.base.UrlCode;
import com.manji.sheet.intercepter.LocalIntercepter;
import com.manji.sheet.model.reqParam.SheetInfoParam;
import com.manji.sheet.utils.HttpClientUtils;

import net.sf.json.JSONArray;
import net.sf.json.JSONObject;


/**
 * 本地登陆相关
 * @author Administrator
 *
 */
public class IndexController extends Controller{
	
	
	@Clear
	public void index(){
		
		
		HttpSession session =getSession();
		
		
		if(session ==null){
			renderText("sb");
			
			
		}else{
			
			
			
			
		}
		
	}
	/**
	 * 退出登录
	 */
	@Clear
	public void loginOut(){
		
		removeSessionAttr("user");
		removeCookie("ssoToken");
		redirect("/");
		
	}
	
	@Clear
	public void login() throws IOException{
		//1. 先拿名字和密码
		String name = getPara("username");
		String password = getPara("password");
		//System.out.println(name+"  "+password);
		//2.发送post请求，拿到一个token
		String url_login = UrlCode.URL_LOGIN+"name="+name+"&password="+password;
		String loginData = HttpClientUtils.postMethod(url_login);
		//System.out.println(loginData);
		//转换JSON
		JSONObject login_json = JSONObject.fromObject(loginData);
		if(login_json.get("code").toString().equals("0101")){
			//账号不存在
			setSessionAttr("message", "ERROR");
			redirect("/");
		}else{
			//System.out.println(login_json.get("data"));
			String token = login_json.get("data").toString();
//			http://192.168.0.68:8080/singleSign/login?name=huanghan&password=123
			//3.token..cookie,把得到的token存在cookie中
			setCookie("ssoToken",token,1000*60*60*24);
			//4.用这个TOKEN发起一个请求，项目名称
			String url_auth = UrlCode.URL_AUTH+"system=sheet&ssoToken="+token;
			String authData = HttpClientUtils.postMethod(url_auth);
			//System.out.println(authData);
			JSONObject auth_json = JSONObject.fromObject(authData);
			JSONObject roleInfo = auth_json.getJSONObject("data").getJSONObject("roleInfo");
			JSONArray menuInfo = auth_json.getJSONObject("data").getJSONArray("menuInfo");
			JSONObject userInfo = auth_json.getJSONObject("data").getJSONObject("userInfo");
			//System.out.println(userInfo.get("username"));
//			http://192.168.0.68:8080/singleSign/auth?system=sheet&ssoToken=2AEC16D5A590964C0F3CA30FCA000507
			//获取返回的用户信息、权限信息、角色信息
			//1用户信息
			Record user = new Record().set("username", userInfo.get("username")).set("dept_name", userInfo.get("dept_name"))
									.set("user_id", userInfo.get("user_id")).set("status", userInfo.get("status"));
			setSessionAttr("user", user);
			redirect("/home");
			//2.角色信息
			//3.目录信息
		}
		
		
	}
	
	@Before(LocalIntercepter.class)
	public void home(){
		
		
		render("home.html");
	}
	

}
