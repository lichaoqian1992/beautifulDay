package com.manji.sheet.controller;

import com.jfinal.aop.Before;
import com.jfinal.core.Controller;
import com.jfinal.plugin.activerecord.Record;
import com.jfinal.upload.UploadFile;
import com.manji.sheet.intercepter.AppIntercepter;
import com.manji.sheet.model.reqParam.SheetInfoParam;
import com.manji.sheet.service.BuyersAppService;
import com.manji.sheet.utils.WorkerNumberUtil;

import java.io.File;
import java.util.ArrayList;
import java.util.List;


//APP接口调用
//@Before(AppIntercepter.class)
public class BuyersAppController extends Controller{
	BuyersAppService appser=new BuyersAppService();
	private WorkerNumberUtil WorkerUtil;


	public void index(){
		renderText("sb");
	}
	/**
	 * 补充资料
	 */
	public void addInfo(){
		setAttr("info", getParaToInt("sheet_id"));
		render("add_data.html");
	}
	

	/**
	 * 商家信息查询
	 */
	public void shopInfo(){

		SheetInfoParam sheetInfo=getBean(SheetInfoParam.class, "");
		Record shopInfo=appser.getShopByName(sheetInfo.getShopId());
		List<Record> codeReportList= WorkerUtil.getcodeReport(sheetInfo.getCodeReport());

		setAttr("sheetInfo",sheetInfo);
		setAttr("shopInfo",shopInfo);//店铺信息
		setAttr("codeReportList",codeReportList);//二级类型信息
		render("business_informant_center.html");
	}

	/**
	 * 商家举报
	 */
	public void shopReport(){
		UploadFile file = this.getFile(); 
		SheetInfoParam sheetInfo=getBean(SheetInfoParam.class, "");
		String stu=appser.saveShopReport(sheetInfo);
//		setAttr("message", stu);
		renderJson(stu);
	}


	/**
	 * 商品举报查询
	 */
	public void goodsReportInfo() {
		SheetInfoParam sheetInfo=getBean(SheetInfoParam.class, "");

		Record commodityInfo=appser.getCommodityInfo(sheetInfo.getArticleId());
		List<Record> codeReportList= WorkerUtil.getcodeReport(sheetInfo.getCodeReport());

		setAttr("sheetInfo",sheetInfo);
		setAttr("commodityInfo",commodityInfo);//店铺商品信息
		setAttr("codeReportList",codeReportList);//二级类型信息
		render("goods_informant_center .html");
	}
	/**
	 * 建议查询
	 */
	public void suggestReportInfo(){
		SheetInfoParam sheetInfo=getBean(SheetInfoParam.class, "");
		List<Record> codeReportList= WorkerUtil.getcodeReport(sheetInfo.getCodeReport());
		setAttr("codeReportList",codeReportList);//二级类型信息
		render("opinion_suggestion.html");
	}
	/**
	 * 商品举报
	 */
	public void goodsReport(){
		SheetInfoParam sheetInfo=getBean(SheetInfoParam.class, "");
	}

	/**
	 * 举报满集员工信息
	 */
	public void manjiReportInfo(){
		SheetInfoParam sheetInfo=getBean(SheetInfoParam.class, "");

		List<Record> codeReportList= WorkerUtil.getcodeReport(sheetInfo.getCodeReport());

		setAttr("sheetInfo",sheetInfo);
		setAttr("codeReportList",codeReportList);//二级类型信息

		render("");
	}
	
	/**
	 * 举报满集员工
	 */
	public void manjiReport(){
		SheetInfoParam sheetInfo=getBean(SheetInfoParam.class, "");
	}

	/**
	 * 举报详情
	 */
	/*public void reportInfo(){
		SheetInfoParam sheetInfo=getBean(SheetInfoParam.class, "");
		List<Record> list=appser.reportInfo(sheetInfo);
		setAttr("reportInfo",list);
		render("");
	}*/

	/**
	 * 纠纷查询
	 */
	public void disputeInfo(){
		SheetInfoParam sheetInfo=getBean(SheetInfoParam.class, "");

		Record orderInfo=appser.getOrderInfo(sheetInfo.getOrderId());
		List<Record> codeReportList= WorkerUtil.getcodeReport(sheetInfo.getCodeReport());

		setAttr("sheetInfo",sheetInfo);
		setAttr("orderInfo",orderInfo);//店铺订单信息
		setAttr("codeReportList",codeReportList);//二级类型信息

		render("");
	}
	/**
	 * 交易纠纷
	 */
	public void dispute(){
		SheetInfoParam sheetInfo=getBean(SheetInfoParam.class, "");
	}

	/**
	 * 建议详情查询
	 */
	public void suggestInfo(){
		List<Record> flow = new ArrayList<>();
		String sheet_no = getPara("sheet_no");
		String codeReport = getPara("codeReport");
		//1.流程进度信息
		flow = appser.findFlow(sheet_no);
		//2.商家的信息
		Record shopInfo = appser.findShopInfo(sheet_no);
		//2.商品的信息
		Record goodInfo = appser.findGoodInfo(sheet_no);
		//3.工单信息
		Record sheet = appser.findSheet(sheet_no);
		//4.工单资料信息
		List<Record> info = appser.findInfo(sheet_no);
		if(flow == null){
			flow.get(0).set("descr", "暂无").set("opr_time", "暂无");
		}
		setAttr("flow", flow);
		setAttr("sheet", sheet);
		setAttr("shopInfo", shopInfo);
		setAttr("goodInfo", goodInfo);
		setAttr("info", info);
		String[] code = sheet.get("code").toString().split("_");
		if(code[0].equals("01")){
			//举报商品
			render("informant_goods.html");
		}else if(code[0].equals("02")){
			render("informant_business.html");
		}else if(code[0].equals("03")){
			
		}else if(code[0].equals("05")){
			render("opinion_suggestion_info.html");
		}
	}

	/**
	 *    查询我的建议或者我的举报
	 */
	public void myInfo(){
		String codeReport = getPara("codeReport");
		String sponsoId = getPara("sponsoId");
		List<Record> suggest = appser.reportInfo(codeReport,sponsoId);
		for(int i=0;i<suggest.size();i++){
			Record shopOrGoodsInfo = appser.findShopOrGoodsInfo(suggest.get(i).get("id").toString(),suggest.get(i).get("type_code").toString());
			if(shopOrGoodsInfo != null){
				suggest.get(i).set("pics", shopOrGoodsInfo.get("img_url"));
			}else{
				suggest.get(i).set("pics", "暂无");
			}
		}
		
		setAttr("list", suggest);
		if(codeReport.equals("05")){
			render("my_suggest.html");
		}else if(codeReport.equals("01-02-03")){
			render("my_instruction.html");
		}
		
	}
	/**
	 * 根据单号修改单据状态
	 */
	public void updateStatus(){
		
		int sheet_id = getParaToInt("sheet_id");
		int status = getParaToInt("status");
		int a = appser.updateStatus(sheet_id,status);
		if(a > 0){
			setAttr("message", "SUCCESS");
		}else{
			setAttr("message", "ERROR");
		}
		renderJson();
	}

	/**
	 * 添加资料
	 */
	public void add(){
		UploadFile file = this.getFile(); 
		SheetInfoParam sheetInfo = new SheetInfoParam();
		System.out.println(getPara("id"));
		long id = Long.parseLong(getPara("id"));
		String descr = getPara("descr");
		//添加资料
		sheetInfo.setReportUser("刘英杰");
		sheetInfo.setId(id);
		sheetInfo.setDescr(descr);
		appser.add(sheetInfo);
		
		redirect("/buyersApp/suggestInfo?sheet_no="+appser.findSheetById(sheetInfo.getId()+"").get("sheet_no").toString());
	}


	/**
	 * 用户取消详情查询
	 */
	public void cancleInfo(){
		render("");
	}
	
	/**
	 * 用户取消
	 */
	public void cancle(){
		SheetInfoParam sheetInfo=getBean(SheetInfoParam.class, "");
	}
	
	
}
