package com.manji.sheet.intercepter;

import com.jfinal.aop.Interceptor;
import com.jfinal.aop.Invocation;
import com.jfinal.core.Controller;
import com.manji.sheet.model.bean.Account;
import com.manji.sheet.utils.GetAccountUtils;

public class AppIntercepter implements Interceptor{

    @Override
    public void intercept(Invocation inv) {
        //获取当前控制器
        Controller controller = inv.getController();

                //先判断是否已经存入了
                Account sessAccount=controller.getSessionAttr("Account");//获取session里面的账户信息
                if (sessAccount==null){//还没有存放账户信息

                    String sessionid=controller.getPara("sessionId");
                    //获取用户信息
                    Account userinfo=GetAccountUtils.getAccount(sessionid);

                    if (userinfo.getUser_id()==null||userinfo.getUser_id().equals("")){
                        //没查到用户信息
                        String path=controller.getRequest().getRequestURI();
                        if (path.contains("shopApp")){
                            controller.render("/WEB-INF/shopApp/error.html");
                        }else{
                            controller.render("/WEB-INF/app/error.html");
                        }
                     }else{
                         //将用户信息存入session
                        controller.setSessionAttr("Account",userinfo);
                        inv.invoke();
                        }
                 }else{
                	//判断一哈，当前传入的session的信息和之前的是否一样
                	 String sessionid=controller.getPara("sessionId");//入口都需要传入sessionId
                	 if(sessionid != null){
                		 Account userinfo2=GetAccountUtils.getAccount(sessionid);
                    	 if(!userinfo2.getUser_id().equals(sessAccount.getUser_id())){
                    		 controller.setSessionAttr("Account",userinfo2);
                    	 } 
                	 }
                    inv.invoke();
                }

    }



}
